# Control from the Internet

In this part of the lab, you will subscribe to commands sent from an MQTT broker to your virtual IoT device.

<img src="./img/04.Control from the Internet/image-20250209214901558.png" alt="image-20250209214901558" style="zoom:33%;" />

## Subscribe to commands

The next step is to subscribe to the commands sent from the MQTT broker and respond to them. In this case, we will "fake" a heating appliance with an LED to indicate what command has been sent. 

### Task

Connect the LED Button

1. Locate the following component in your Sensor kit.

   <img src="https://media.rs-online.com/image/upload/bo_1.5px_solid_white,b_auto,c_pad,dpr_2,f_auto,h_399,q_auto,w_710/c_pad,h_399,w_710/Y1887114-01?pgw=1" alt="Seeed Studio Grove - Red LED Button" style="zoom: 25%;" />

   In this lab, we will just use the LED aspect of this button. 

2. Connect the LED button to **D12** on the HAT

Subscribe to commands.

1. Open the sensor project in VS Code.

1. If you are using a virtual IoT device, ensure the terminal is running the virtual environment. If you are using a Raspberry Pi you won't be using a virtual environment.

1. Add the following import statement at the top of the program:
   ~~~python
   from grove.gpio import GPIO
   ~~~

   

1. Add the following code after the definitions of the `client_telemetry_topic`:

   ```python
   server_command_topic = id + '/commands'
   
   button_led = GPIO(12, GPIO.OUT)
   ```

   The `server_command_topic` is the MQTT topic the device will subscribe to receive commands.

1. Add the following code just above the main loop, after the `mqtt_client.loop_start()` line:

   ```python
   def handle_command(client, userdata, message):
       payload = json.loads(message.payload.decode())
       print("Message received:", payload)
   
       if payload['heating_on']:
           button_led.write(1)
       else:
           button_led.write(0)
   
   mqtt_client.subscribe(server_command_topic)
   mqtt_client.on_message = handle_command
   ```

   This code defines a function, `handle_command`, that reads a message as a JSON document and looks for the value of the `led_on` property. If it is set to `True` the LED is turned on, otherwise it is turned off.

   The MQTT client subscribes on the topic that the server will send messages on and sets the `handle_command` function to be called when a message is received.

   > üíÅ The `on_message` handler is called for all topics subscribed to. If you later write code that listens to multiple topics, you can get the topic that the message was sent to from the `message` object passed to the handler function.

1. Run the code in the same way as you ran the code from the previous part of the assignment. If you are using a virtual IoT device, then make sure the CounterFit app is running and the light sensor and LED have been created on the correct pins.

1. Adjust the light levels detected by your physical or virtual device. Messages being received and commands being sent will be written to the terminal. The LED will also be turned on and off depending on the light level.

üòÄ You have successfully coded your device to respond to commands from an vice.
