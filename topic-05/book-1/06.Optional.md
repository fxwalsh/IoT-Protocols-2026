# OPTIONAL: Who left the door open?

So the Smart Sensing device is designed to be mounted on a door. The device will, in addition to the previous functions, send a message indicating the state of the door (Open, state).

To do this we can use the Sensehat's IMU unit, similar to what aircraft use navigate. This enables us to get the orientation of the door in terms of pitch, roll, and yaw. (so you can also tell if the door has been completely removed and lying on the ground also!)

# Display Door State

To make things easier to prototype with the RPi, we'll write a script to check if the RPi is "right way up" (roll should be approx 0 deg), or upside down (roll should be approx. 180 deg). It just makes it easier to test, really you should use yaw or pitch.

+ In *~/mqtt*, create a script called *door_state_pub.py* and enter the following code:

```python
#!/usr/bin/python3
from sense_hat import SenseHat
import time

sense = SenseHat()
sense.set_imu_config(True, True, True) #turn IMU sensors on  

def door_state():
    #global orientation
    state=0
    while True:
        orientation = sense.get_orientation()
        if orientation["roll"] > 355.0  or orientation["roll"] < 5.0 :
            state=0
        else:
            state=1
        print(state)
        time.sleep(.1)

if __name__ == "__main__":
    door_state()
```
Place your RPi on a flat surface and run the program: ``python3 door_state_pub.py``.  
Test the program and check it works: it should print "0"(state) to the console if the RPi is flat on the desk, "1"(Open) if you tilt it/turn it upside down(don't drop it!).

## Publish changes to Door State

Now, similar to previous steps, modify *door_state_pub.py* to publish the door state in the */doors/front/* topic. This time we're only interested a change of state, so we will only publish when the door moves from open to closed and visa versa.

+ Add the following code (taken from previous step) just underneath the existing ``import`` statements

```python
import paho.mqtt.client as mqtt
import paho.mqtt.publish as publish
from urllib.parse import urlparse
import sys

# Define event callbacks
def on_connect(client, userdata, flags, rc):
    print("Connection Result: " + str(rc))

def on_publish(client, obj, mid):
    print("Message ID: " + str(mid))

mqttc = mqtt.Client()

# Assign event callbacks
mqttc.on_connect = on_connect
mqttc.on_publish = on_publish

# parse mqtt url for connection details
url_str = sys.argv[1]    
print(url_str)
url = urlparse(url_str)
base_topic = url.path[1:]

# Connect
if (url.username):
    mqttc.username_pw_set(url.username, url.password)

mqttc.connect(url.hostname, url.port)
mqttc.loop_start()
```

+ In *door_pub.py*, update the ``door_state()`` function to the following: 

```python
def door_state():
    prevState=0
    state=0
    while True:
        orientation = sense.get_orientation()
        if orientation["roll"] > 355.0  or orientation["roll"] < 5.0 :
            state=0
        else:
            state=1
        
        if state != prevState:  # Only publish when state changes
            mqttc.publish(base_topic+"/doors/front", state)
            prevState = state
        time.sleep(.1)
```

+ As before, place your RPi on a flat surface and run the program using ``python3 door_state_pub.py``. You should see console output from the MQTT event callback functions when the state changes(i.e. you tilt the RPi). :

```bash
pi@sensePi:~/week7 $ python3 door_pub.py mqtt://broker.hivemq.com:1883/fxwalsh/home
mqtt://broker.hivemq.com:1883/fxwalsh/home
Connection Result: 0
Message ID: 1
Message ID: 2
Message ID: 3
Message ID: 4
```

+ Again, as before in a previous step, in the CompSys VM run the *client_sub.py*. You should now see the published changes arrive into the subscribed client.

```bash
compsys@compsys-virtualbox:~/labs/week7$ python3 client_sub.py mqtt://broker.hivemq.com:1883/fxwalsh/home
broker.hivemq.com
1883
Connection Result: 0
Subscribed,  QOS granted: (0,)
Topic:fxwalsh/home/door/front,Payload:b'1'
Topic:fxwalsh/home/door/front,Payload:b'0'
Topic:fxwalsh/home/door/front,Payload:b'1'
Topic:fxwalsh/home/door/front,Payload:b'0'
Topic:fxwalsh/home/door/front,Payload:b'1'
Topic:fxwalsh/home/door/front,Payload:b'0'
Topic:fxwalsh/home/door/front,Payload:b'1'
Topic:fxwalsh/home/door/front,Payload:b'0'

```