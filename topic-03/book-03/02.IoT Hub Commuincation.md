## Communicate with IoT Hub

In the previous lab, you used MQTT and sent messages back and forward on different topics, with the different topics having different purposes. Rather than send messages over different topics, IoT Hub has a number of defined ways for the device to communicate with the Hub, or for the Hub to communicate with the device.

> üíÅ Under the hood this communication between IoT Hub and your device can use MQTT, HTTPS or AMQP.

* Device to cloud (D2C) messages - these are messages sent from a device to IoT Hub, such as telemetry. They can then be read off the IoT Hub by your application code.

  > üéì Under the hood, IoT Hub uses an Azure service called [Event Hubs](https://docs.microsoft.com/azure/event-hubs/?WT.mc_id=academic-17441-jabenn). When you write code to read messages sent to the hub, these are often called events.

* Cloud to device (C2D) messages - these are messages sent from application code, via an IoT Hub to an IoT device

* Direct method requests - these are messages sent from application code via an IoT Hub to an IoT device to request that the device does something, such as control an actuator. These messages require a response so your application code can tell if it was successfully processed.

* Device twins - these are JSON documents kept synchronized between the device and IoT Hub, and are used to store settings or other properties either reported by the device, or should be set on the device (known as desired) by the IoT Hub.

IoT Hub can store messages and direct method requests for a configurable period of time (defaulting to one day), so if a device or application code loses connection, it can still retrieve messages sent whilst it was offline after it reconnects. Device twins are kept permanently in the IoT Hub, so at any time a device can reconnect and get the latest device twin.

‚úÖ Do some research: Read more on these message types on the [Device-to-cloud communications guidance](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-d2c-guidance?WT.mc_id=academic-17441-jabenn), and the [Cloud-to-device communications guidance](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-c2d-guidance?WT.mc_id=academic-17441-jabenn) in the IoT Hub documentation.

## Connect your device to the IoT service

Once the hub is created, your IoT device can connect to it. Only registered devices can connect to a service, so you will need to register your device first. When you register you can get back a connection string that the device can use to connect. This connection string is device specific, and contains information about the IoT Hub, the device, and a secret key that will allow this device to connect.

> üéì A connection string is a generic term for a piece of text that contains connection details. These are used when connecting to IoT Hubs, databases and many other services. They usually consist of an identifier for the service, such as a URL, and security information such as a secret key. These are passed to SDKs to connect to the service.

> ‚ö†Ô∏è Connection strings should be kept secure! Security will be covered in more detail in a future lesson.

### Task - register your IoT device

The IoT device can be registered with your IoT Hub using the Azure CLI.

1. Run the following command to register a device:

   ```sh
   az iot hub device-identity create --device-id soil-moisture-sensor \
                                     --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name you used for your IoT Hub.

   This will create a device with an ID of `soil-moisture-sensor`.

1. When your IoT device connects to your IoT Hub using the SDK, it needs to use a connection string that gives the URL of the hub, along with a secret key. Run the following command to get the connection string:

   ```sh
   az iot hub device-identity connection-string show --device-id soil-moisture-sensor \
                                                     --output table \
                                                     --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name you used for your IoT Hub.

1. Store the connection string that is shown in the output as you will need it later.

### Task - connect your IoT device to the cloud

Do the following on your Rasppberry Pi using SSH(or on your Virtual IoT Device)

1. Open the `soil-moisture-sensor` folder in VS Code. (Make sure the virtual environment is running in the terminal **if you are using a virtual IoT device**).

1. Install some additional Pip packages:

   ```sh
   pip3 install azure-iot-device
   ```

   `azure-iot-device` is a library to communicate with your IoT Hub.

1. Add the following imports to the top of the `app.py` file, below the existing imports:

   ```python
   from azure.iot.device import IoTHubDeviceClient, Message, MethodResponse
   ```

   This code imports the SDK to communicate with your IoT Hub.

1. Remove the `import paho.mqtt.client as mqtt` line as this library is no longer needed. Remove all the MQTT code including the topic names, all code that uses `mqtt_client` and the `handle_command`. Keep the `while True:` loop, just delete the `mqtt_client.publish` line form this loop.

1. Add the following code below the import statements:

   ```python
   connection_string = "<connection string>"
   ```

   Replace `<connection string>` with the connection string you retrieved for the device earlier in this lesson.

   > üíÅ This is not best practice. Connection strings should never be stored in source code, as this can be checked into source code control and found by anyone. We are doing this here for the sake of simplicity. Ideally you should use something like an environment variable and a tool like [`python-dotenv`](https://pypi.org/project/python-dotenv/). You will learn more about this in an upcoming lesson.

1. Below this code, add the following to create a device client object that can communicate with IoT Hub, and connect it:

   ```python
   device_client = IoTHubDeviceClient.create_from_connection_string(connection_string)
   
   print('Connecting')
   device_client.connect()
   print('Connected')
   ```

1. Run this code. You will see your device connect.

   ```output
   pi@raspberrypi:~/soil-moisture-sensor $ python3 app.py 
   Connecting
   Connected
   Soil moisture: 379
   ```

## Send telemetry

Now that your device is connected, you can send telemetry to the IoT Hub instead of the MQTT broker.

### Task - send telemetry

1. Add the following code inside the `while True` loop, just before the sleep:

   ```python
   message = Message(json.dumps({ 'soil_moisture': soil_moisture }))
   device_client.send_message(message)
   ```

   This code creates an IoT Hub `Message` containing the soil moisture reading as a JSON string, then sends this to the IoT Hub as a device to cloud message.

## Handle commands

Your device needs to handle a command from the server code to control the relay. This is sent as a direct method request.

## Task - handle a direct method request

1. Add the following code before the `while True` loop:

   ```python
   def handle_method_request(request):
       print("Direct method received - ", request.name)
   
       if request.name == "relay_on":
           relay.on()
       elif request.name == "relay_off":
           relay.off()    
   ```

   This defines a method, `handle_method_request`, that will be called when a direct method is called by the IoT Hub. Each direct method has a name, and this code expects a method called `relay_on` to turn the relay on, and `relay_off` to turn the relay off.

   > üíÅ This could also be implemented in a single direct method request, passing the desired state of the relay in a payload that can be passed with the method request and available from the `request` object.

1. Direct methods require a response to tell the calling code that they have been handled. Add the following code at the end of the `handle_method_request` function to create a response to the request:

   ```python
   method_response = MethodResponse.create_from_method_request(request, 200)
   device_client.send_method_response(method_response)
   ```

   This code sends a response to the direct method request with an HTTP status code of 200, and sends this back to the IoT Hub.

1. Add the following code below this function definition:

   ```python
   device_client.on_method_request_received = handle_method_request
   ```

   This code tells the IoT Hub client to call the `handle_method_request` function when a direct method is called.

> üíÅ You can find this code in the [code/pi](code/pi) or [code/virtual-device](code/virtual-device) folder.

üòÄ Your soil moisture sensor program is connected to your IoT Hub!

### Task - monitor events

For now, you won't be updating your server code. Instead you can use the Azure CLI to monitor events from your IoT device.

1. Make sure your IoT device is running and sending soil moisture telemetry values

1. Run the following command in your command prompt or terminal to monitor messages sent to your IoT Hub:

   ```sh
   az iot hub monitor-events --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name you used for your IoT Hub.

   You will see messages appear in the console output as they are sent by your IoT device.

   ```output
   Starting event monitor, use ctrl-c to stop...
   {
       "event": {
           "origin": "soil-moisture-sensor",
           "module": "",
           "interface": "",
           "component": "",
           "payload": "{\"soil_moisture\": 376}"
       }
   },
   {
       "event": {
           "origin": "soil-moisture-sensor",
           "module": "",
           "interface": "",
           "component": "",
           "payload": "{\"soil_moisture\": 381}"
       }
   }
   ```

   The contents of the `payload` will match the message sent by your IoT device.

   > At the time of writing, the `az iot` extension is not fully working on Apple Silicon. If you are using an Apple Silicon device, you will need to monitor the messages a different way, such as using the [Azure IoT Tools for Visual Studio Code](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-vscode-iot-toolkit-cloud-device-messaging).

1. These messages have a number of properties attached to them automatically, such as the timestamp they were sent. These are known as *annotations*. To view all the message annotations, use the following command:

   ```sh
   az iot hub monitor-events --properties anno --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name you used for your IoT Hub.

   You will see messages appear in the console output as they are sent by your IoT device.

   ```output
   Starting event monitor, use ctrl-c to stop...
   {
       "event": {
           "origin": "soil-moisture-sensor",
           "module": "",
           "interface": "",
           "component": "",
           "properties": {},
           "annotations": {
               "iothub-connection-device-id": "soil-moisture-sensor",
               "iothub-connection-auth-method": "{\"scope\":\"device\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
               "iothub-connection-auth-generation-id": "637553997165220462",
               "iothub-enqueuedtime": 1619976150288,
               "iothub-message-source": "Telemetry",
               "x-opt-sequence-number": 1379,
               "x-opt-offset": "550576",
               "x-opt-enqueued-time": 1619976150277
           },
           "payload": "{\"soil_moisture\": 381}"
       }
   }
   ```

   The time values in the annotations are in [UNIX time](https://wikipedia.org/wiki/Unix_time), representing the number of seconds since midnight on 1<sup>st</sup> January 1970.

   Exit the event monitor when you are done.

### Task - control your IoT device

You can also use the Azure CLI to call direct methods on your IoT device.

1. Run the following command in your command prompt or terminal to invoke the `relay_on` method on the IoT device:

   ```sh
   az iot hub invoke-device-method --device-id soil-moisture-sensor --method-name relay_on --method-payload '{}' --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name you used for your IoT Hub.

   This sends a direct method request for the method specified by `method-name`. Direct methods can take a payload containing data for the method, and this can be specified in the `method-payload` parameter as JSON.

   You will see the relay turn on, and the corresponding output from your IoT device:

   ```output
   Direct method received -  relay_on
   ```

1. Repeat the above step, but set the `--method-name` to `relay_off`. You will see the relay turn off and the corresponding output from the IoT device.

---

## üöÄ Challenge

The free tier of IoT Hub allows 8,000 messages a day. The code you wrote sends telemetry messages every 10 seconds. How many messages a day is one message every 10 seconds?

Think about how often soil moisture measurements should be sent? How can you change your code to stay within the free tier and check as often as needed but not too often? What if you wanted to add a second device?

## Review & Self Study

The IoT Hub SDK is open source for both Arduino and Python. In the code repos on GitHub there are a number of samples showing how work with different IoT Hub features.

* If you are using a Raspberry Pi or Virtual device, check out the [Python samples on GitHub](https://github.com/Azure/azure-iot-sdk-python/tree/master/azure-iot-hub/samples)

