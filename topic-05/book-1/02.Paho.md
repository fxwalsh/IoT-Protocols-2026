# MQTT

### Eclipse Paho
You will use the [Eclipse Paho Python client library](https://pypi.org/project/paho-mqtt/) to create a publish and subscribe program as shown in the above diagram. 

+ SSH into your Rasppberry Pi and make a new folder called *mqtt* in the home folder

+ Run the following command in the RPi To install the relevant libraries on the RPi:


```bash
sudo apt-get install mosquitto
```

```bash
sudo pip3 install paho-mqtt
sudo pip3 install schedule
```

(it's assumed you have the SenseHAT installed - if not refer to prev)

## Publish Temperature from the RPi

+ On your RPi, create a directory called **mqtt** in the home directory.
+ In the  **~/mqtt** folder, create a new script called ``client_pub.py`` and enter the following code:

~~~python
#!/usr/bin/python3

import paho.mqtt.client as mqtt
from urllib.parse import urlparse
import sys
import time
import json
from sense_hat import SenseHat
import schedule

sense = SenseHat()
sense.clear()

# Define event callbacks
def on_connect(client, userdata, flags, rc):
    print("Connection Result: " + str(rc))

def on_publish(client, obj, mid):
    print("Message ID: " + str(mid))

mqttc = mqtt.Client()

# Assign event callbacks
mqttc.on_connect = on_connect
mqttc.on_publish = on_publish

# parse mqtt url for connection details
url_str = sys.argv[1]
print(url_str)
url = urlparse(url_str)
base_topic = url.path[1:]

# Connect
if (url.username):
    mqttc.username_pw_set(url.username, url.password)
try:
    print("Connecting to "+  url_str)    
    mqttc.connect(url.hostname, url.port)
    mqttc.loop_start()
except Exception as e:
    print("Connection failed: " + str(e))
    exit(1)

def publish_temperature():
    temp=round(sense.get_temperature(),2)
    temp_json=json.dumps({"temperature":temp, "timestamp":time.time()})
    mqttc.publish(base_topic+"/temperature", temp_json)

# Publish a message to temp every 10 seconds
schedule.every(10).seconds.do(publish_temperature)

try:
    while True:
        schedule.run_pending()
        time.sleep(1)
except KeyboardInterrupt:
    print("Script termination requested, shutting down.")
finally:
    mqttc.loop_stop()
    mqttc.disconnect()
~~~

+ Examine the above code. The program expects a **MQTT URL** as the first command line argument. The connection details for MQTT broker as then parsed from the URL. 
+ You will publish the temperature reading to the following URL: ``mqtt://broker.emqx.io:1883/YOUR_ID/home`` where you replace ``YOUR_ID`` in the URL with a memorable id of your choice (For example, I use my Github username, ``fxwalsh``, so my URL is : ``mqtt://broker.emqx.io:1883/fxwalsh/home``).
+ The program publishes the temperature and a timestamp from the device in question, which in this case is the time in seconds since the 1/1/1970 as a floating point number(the [Linux epoch](https://en.wikipedia.org/wiki/Unix_time)).
+ Run the program, ``python3 client_pub.py mqtt://broker.emqx.io:1883/YOUR_ID/home`` and you should see an output to the console similar to the following:

~~~bash
mqtt://broker.emqx.io:1883/fxwalsh/home
Message ID: 1
Connection Result: 0
Message ID: 2
Message ID: 3
Message ID: 4
~~~

The ``Message ID: ...`` indicates on_publish callback and is called every time a value is published to the broker.  ``Connection Result: 0`` is output from the on_connect callback and ``0`` is success but any other number indicates a refused connection. For a more detailed explanation see: [Paho Callbacks](https://pypi.org/project/paho-mqtt/#callbacks).

Your RPi is now hopefully publishing temperature messages to the cloud MQTT broker. Any device anywhere on the internet can now subscribe and use this data.  
**NOTE: Leave this program running for the next section**

## Subscribe

In this section you will create a subscription to the data you are publishing to the MQTT broker. 
You can create the following program on another machine if you wish, for example your computer or laptop. If you want to use the RPi just for convenience, it's OK to run the following subscribe program on the RPi also by opening a second SSH session (lets just pretend it's on another device somewhere else in the world!).

**The following instructions assumes you're doing it on the RPi

+ In the , create a new folder called */labs/week6*. 
+ in the ``week6`` directory, create a new Python program file called ``client_sub.py`` with the following content:

~~~python
#!/usr/bin/python3

import paho.mqtt.client as mqtt
from urllib.parse import urlparse
import sys

# Define event callbacks
def on_connect(client, userdata, flags, rc):
    print("Connection Result: " + str(rc))

def on_message(client, obj, msg):
    print("Topic:"+msg.topic + ",Payload:" + str(msg.payload))

def on_subscribe(client, obj, mid, granted_qos):
    print("Subscribed,  QOS granted: "+ str(granted_qos))


mqttc = mqtt.Client()

# Assign event callbacks
mqttc.on_message = on_message
mqttc.on_connect = on_connect
mqttc.on_subscribe = on_subscribe

# parse mqtt url for connection details
url_str = sys.argv[1]
url = urlparse(url_str)
base_topic = url.path[1:]

# Connect
if (url.username):
    mqttc.username_pw_set(url.username, url.password)
try:
    print("Connecting to "+  url_str)    
    mqttc.connect(url.hostname, url.port)
except Exception as e:
    print("Connection failed: " + str(e))
    exit(1)
# Continue the network loop, exit when an error occurs
try:  
    # Start subscribe, with QoS 0
    mqttc.subscribe(base_topic+"/#",qos=0)
    mqttc.loop_forever()
except KeyboardInterrupt:#ctrl+c issues interrupt
    pass
finally:
    mqttc.loop_stop()
    mqttc.disconnect()
    print("Disconnected from MQTT broker.")
~~~

+ Now run it as before, **using the same URL used in for the publishing program** as a command line argument. You should see data output to the console similar to the following:

~~~bash
Connection Result: 0
Subscribed,  QOS granted: (0,)
Topic:fxwalsh/home/temperature,Payload:{"timestamp": 1541453620.862879, "temperature": 34.48}
Topic:fxwalsh/home/temperature,Payload:{"timestamp": 1541453680.936523, "temperature": 34.41}
~~~

You now have a working MQTT publisher/subscriber!

### Exercises

The SenseHAT on the RPi has a few other environment sensors, for example pressure and humidity. If you presume to operate the RPi as a multiple environment, you need to publish this data also and create a suitable channel structure for MQTT.
+ On the RPi, stop ``client_pub.py`` by entering ``ctrl + c`` in the terminal window.
+ Update the code to publish humidity data also..
  + Use `humidity=sense.get_humidity()` to get the humidity. 



+ How many bytes are you using for the payload at the moment?

~~~json
{"Temperature": 20.635 }
~~~

+ How small could you make the message? (hint: MQTT does not mandate the use of JSON, you can encode data any way you want)

  