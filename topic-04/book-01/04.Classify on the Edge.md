## Register an IoT Edge device

To use an IoT Edge device, it needs to be registered in IoT Hub.

### Task - register an IoT Edge device

1. Create an IoT Hub in the `fruit-quality-detector` resource group. Give it a unique name based around `fruit-quality-detector`.

1. Register an IoT Edge device called `fruit-quality-detector-edge` in your IoT Hub. The command to do this is similar to the one used to register a non-edge device, except you pass the `--edge-enabled` flag.

   ```sh
   az iot hub device-identity create --edge-enabled --device-id fruit-quality-detector-edge --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name of your IoT Hub.

1. Get the connection string for your device using the following command:

   ```sh
   az iot hub device-identity connection-string show --device-id fruit-quality-detector-edge --output table --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name of your IoT Hub.

   Take a copy of the connection string that is shown in the output.

## Set up an IoT Edge device

Once you have created the edge device registration in your IoT Hub, you can set up the edge device.

### Task - Install and start the IoT Edge Runtime

**The IoT Edge runtime only runs Linux containers.** It can be run on Linux, or on Windows using Linux Virtual Machines.

* If you are using a Raspberry Pi as your IoT device, then this runs a supported version of Linux and can host the IoT Edge runtime. Follow the [install Azure IoT Edge for Linux guide on Microsoft docs](https://docs.microsoft.com/azure/iot-edge/how-to-install-iot-edge?WT.mc_id=academic-17441-jabenn) to install IoT Edge and set the connection string.

  > üíÅ Remember, Raspberry Pi OS is a variant of Debian Linux.

* If you are not using a Raspberry Pi, but have a Linux computer, you can run the IoT Edge runtime. Follow the [install Azure IoT Edge for Linux guide on Microsoft docs](https://docs.microsoft.com/azure/iot-edge/how-to-install-iot-edge?WT.mc_id=academic-17441-jabenn) to install IoT Edge and set the connection string.

* If you are using Windows, you can install the IoT Edge runtime in a Linux Virtual Machine by following the [install and start the IoT Edge runtime section of the deploy your first IoT Edge module to a Windows device quickstart on Microsoft docs](https://docs.microsoft.com/azure/iot-edge/quickstart?WT.mc_id=academic-17441-jabenn#install-and-start-the-iot-edge-runtime). You can stop when you reach the *Deploy a module* section.

* If you are using macOS, you can create a virtual machine (VM) in the cloud to use for your IoT Edge device. These are computers you can create in the cloud and access over the internet. You can create a Linux VM that has IoT Edge installed. Follow the [create a virtual machine running IoT Edge guide](vm-iotedge.md) for instructions on how to do this.

## Export your model

To run the classifier at the edge, it needs to be exported from Custom Vision. Custom Vision can generate two types of models - standard models and compact models. Compact models use various techniques to reduce the size of the model, making it small enough to be downloaded and deployed on IoT devices.

When you created the image classifier, you used the *Food* domain, a version of the model that is optimized for training on food images. In Custom Vision, you change the domain of your project, using your training data to train a new model with the new domain. All of the domains supported by Custom Vision are available as standard and compact.

### Task - train your model using the Food (compact) domain

1. Launch the Custom Vision portal at [CustomVision.ai](https://customvision.ai) and sign in if you don't have it open already. Then open your `fruit-quality-detector` project.

1. Select the **Settings** button (the ‚öô icon)

1. In the *Domains* list, select *Food (compact)*

1. Under *Export Capabilities*, make sure *Basic platforms (Tensorflow, CoreML, ONNX, ...)* is selected.

1. At the bottom of the Settings page, select **Save Changes**.

1. Retrain the model with the **Train** button, selecting *Quick training*.

### Task - export your model

Once the model has been trained, it needs to be exported as a container.

1. Select the **Performance** tab, and find your latest iteration that was trained using the compact domain.

1. Select the **Export** button at the top.

1. Select **DockerFile**, then choose a version that matches your edge device:

   * If you are running IoT Edge on a Linux computer, a Windows computer or a Virtual Machine, select the *Linux* version.
   * If you are running IoT Edge on a Raspberry Pi, select the *ARM (Raspberry Pi 3)* version.

   > üéì Docker is one of the most popular tools for managing containers, and a DockerFile is a set of instructions on how to set up the container.

1. Select **Export** to get Custom Vision to create the relevant files, then **Download** to download them in a zip file.

1. Save the files to your computer, then unzip the folder.

The Docker file in the exported files lacks some dependencies required for deployment to the Rapsberry Pi Bulleye OS (32 bit). 

6. In the unzipped folder, **replace the contents of Dockerfile with the following**:
   ```dockerfile
   FROM python:3.9-slim-bullseye
   
   RUN apt-get update && apt-get install -y libtiff5
   RUN apt-get install -y libopenjp2-7
   RUN apt-get install -y libxcb1
   RUN apt-get install -y libopenblas0
   
   RUN pip install --no-cache-dir "flask<3" "pillow<11" "numpy<2" tflite-runtime~=2.13.0 --extra-index-url=https://www.piwheels.org/simple
   
   COPY app /app
   EXPOSE 80
   WORKDIR /app
   
   CMD python -u app.py
   ```

   

## Prepare your container for deployment

![Containers are built then pushed to a container registry, then deployed from the container registry to an edge device using IoT Edge](./img/04.Classify on the Edge/container-edge-flow.png)

Once you have downloaded your model, it needs to be built into a container, then pushed to a container registry - an online location where you can store containers. IoT Edge can then download the container from the registry and push it to your device.

![THe Azure Container Registry logo](./img/04.Classify on the Edge/azure-container-registry-logo.png)

The container registry you will use for this lesson is Azure Container Registry. This is not a free service, so to save money make sure you [clean up your project](../../../clean-up.md) once you are finished.

> üíÅ You can see the costs of using an Azure Container Registry in the [Azure Container Registry pricing page](https://azure.microsoft.com/pricing/details/container-registry/?WT.mc_id=academic-17441-jabenn)

### Task - install Docker

To build and deploy the classifier classifier, you may need to install [Docker](https://www.docker.com/).

You will only need to do this if you plan to build your container from a different device that the one you installed IoT Edge on - as part of installing IoT Edge, Docker is installed for you.

1. If you building the docker container on a different device from your IoT Edge device, follow the Docker installation instructions on the [Docker install page](https://www.docker.com/products/docker-desktop) to install Docker Desktop or the Docker engine. Ensure it is running after installation.

### Task - create a container registry resource

1. Run the following command from your Terminal or command prompt to create an Azure Container Registry resource:

   ```sh
   az acr create --resource-group fruit-quality-detector --sku Basic --name <Container registry name>
   ```

   Replace `<Container registry name>` with a unique name for your container registry, using letters and numbers only. Base this around `fruitqualitydetector`. This name becomes part of the URL to access the container registry, so needs to be globally unique.

1. Log in to the Azure Container Registry with the following command:

   ```sh
   az acr login --name <Container registry name>
   ```

   Replace `<Container registry name>` with the name you used for your container registry.

1. Set the container registry into admin mode so you can generate a password with the following command:

   ```sh
   az acr update --admin-enabled true --name <Container registry name>
   ```

   Replace `<Container registry name>` with the name you used for your container registry.

1. Generate passwords for your container registry with the following command:

   ```sh
    az acr credential renew --password-name password --output table --name <Container registry name>
   ```

   Replace `<Container registry name>` with the name you used for your container registry.

   Take a copy of the value of `PASSWORD`, as you will need this later.

### Task - build your container

What you downloaded from Custom Vision was a DockerFile containing instructions on how the container should be built, along with application code that will be run inside the container to host your custom vision model, along with a REST API to call it. You can use Docker to build a tagged container from the DockerFile, then push it to your container registry.

> üéì Containers are given a tag that defines a name and version for them. When you need to update a container you can build it with the same tag but a newer version.

1. Open your terminal or command prompt and navigate to the unzipped model that you downloaded from Custom Vision.

1. Run the following command to build and tag the image:

   ```sh
   docker build --platform linux/armhf -t <Container registry name>.azurecr.io/classifier:v1 .
   ```

   Replace `<platform>` with the platform that this container will run on. For this module, you are using a Raspberry Pi with a 32 bit OS, so set this to `linux/armhf`(as above). If you're running 64 bit OS set this to `linux/amd64`.

   Replace `<Container registry name>` with the name you used for your container registry.

   > üíÅ If you are running on Linux or Raspberry Pi OS you nay need to use `sudo` to run this command.

   Docker will build the image, configuring all the software needed. The image will then be tagged as `classifier:v1`.

   ```output
   ‚ûú  d4ccc45da0bb478bad287128e1274c3c.DockerFile.Linux docker build --platform linux/amd64 -t  fruitqualitydetectorjimb.azurecr.io/classifier:v1 .
   [+] Building 102.4s (11/11) FINISHED
    => [internal] load build definition from Dockerfile
    => => transferring dockerfile: 131B
    => [internal] load .dockerignore
    => => transferring context: 2B
    => [internal] load metadata for docker.io/library/python:3.7-slim
    => [internal] load build context
    => => transferring context: 905B
    => [1/6] FROM docker.io/library/python:3.7-slim@sha256:b21b91c9618e951a8cbca5b696424fa5e820800a88b7e7afd66bba0441a764d6
    => => resolve docker.io/library/python:3.7-slim@sha256:b21b91c9618e951a8cbca5b696424fa5e820800a88b7e7afd66bba0441a764d6
    => => sha256:b4d181a07f8025e00e0cb28f1cc14613da2ce26450b80c54aea537fa93cf3bda 27.15MB / 27.15MB
    => => sha256:de8ecf497b753094723ccf9cea8a46076e7cb845f333df99a6f4f397c93c6ea9 2.77MB / 2.77MB
    => => sha256:707b80804672b7c5d8f21e37c8396f319151e1298d976186b4f3b76ead9f10c8 10.06MB / 10.06MB
    => => sha256:b21b91c9618e951a8cbca5b696424fa5e820800a88b7e7afd66bba0441a764d6 1.86kB / 1.86kB
    => => sha256:44073386687709c437586676b572ff45128ff1f1570153c2f727140d4a9accad 1.37kB / 1.37kB
    => => sha256:3d94f0f2ca798607808b771a7766f47ae62a26f820e871dd488baeccc69838d1 8.31kB / 8.31kB
    => => sha256:283715715396fd56d0e90355125fd4ec57b4f0773f306fcd5fa353b998beeb41 233B / 233B
    => => sha256:8353afd48f6b84c3603ea49d204bdcf2a1daada15f5d6cad9cc916e186610a9f 2.64MB / 2.64MB
    => => extracting sha256:b4d181a07f8025e00e0cb28f1cc14613da2ce26450b80c54aea537fa93cf3bda
    => => extracting sha256:de8ecf497b753094723ccf9cea8a46076e7cb845f333df99a6f4f397c93c6ea9
    => => extracting sha256:707b80804672b7c5d8f21e37c8396f319151e1298d976186b4f3b76ead9f10c8
    => => extracting sha256:283715715396fd56d0e90355125fd4ec57b4f0773f306fcd5fa353b998beeb41
    => => extracting sha256:8353afd48f6b84c3603ea49d204bdcf2a1daada15f5d6cad9cc916e186610a9f
    => [2/6] RUN pip install -U pip
    => [3/6] RUN pip install --no-cache-dir numpy~=1.17.5 tensorflow~=2.0.2 flask~=1.1.2 pillow~=7.2.0
    => [4/6] RUN pip install --no-cache-dir mscviplib==2.200731.16
    => [5/6] COPY app /app
    => [6/6] WORKDIR /app
    => exporting to image
    => => exporting layers
    => => writing image sha256:1846b6f134431f78507ba7c079358ed66d944c0e185ab53428276bd822400386
    => => naming to fruitqualitydetectorjimb.azurecr.io/classifier:v1
   ```

### Task - push your container to your container registry

1. Use the following command to push your container to your container registry:

   ```sh
   docker push <Container registry name>.azurecr.io/classifier:v1
   ```

   Replace `<Container registry name>` with the name you used for your container registry.

   > üíÅ If you are running Linux you nay need to use `sudo` to run this command.

   The container will be pushed to the container registry.

   ```output
   ‚ûú  d4ccc45da0bb478bad287128e1274c3c.DockerFile.Linux docker push fruitqualitydetectorjimb.azurecr.io/classifier:v1
   The push refers to repository [fruitqualitydetectorjimb.azurecr.io/classifier]
   5f70bf18a086: Pushed 
   8a1ba9294a22: Pushed 
   56cf27184a76: Pushed 
   b32154f3f5dd: Pushed 
   36103e9a3104: Pushed 
   e2abb3cacca0: Pushed 
   4213fd357bbe: Pushed 
   7ea163ba4dce: Pushed 
   537313a13d90: Pushed 
   764055ebc9a7: Pushed 
   v1: digest: sha256:ea7894652e610de83a5a9e429618e763b8904284253f4fa0c9f65f0df3a5ded8 size: 2423
   ```

1. To verify the push, you can list the containers in your registry with the following command:

   ```sh
   az acr repository list --output table --name <Container registry name> 
   ```

Replace `<Container registry name>` with the name you used for your container registry.
    

```output
    ‚ûú  d4ccc45da0bb478bad287128e1274c3c.DockerFile.Linux az acr repository list --name fruitqualitydetectorjimb --output table
    Result
    ----------
    classifier
```

You will see your classifier listed in the output.

## Deploy your container

Your container can now be deployed to your IoT Edge device. To deploy you need to define a deployment manifest - a JSON document that lists the modules that will be deployed to the edge device.

### Task - create the deployment manifest

1. Create a new file called `deployment.json` somewhere on your computer.

1. Add the following to this file:

   ```json
   {
       "content": {
           "modulesContent": {
               "$edgeAgent": {
                   "properties.desired": {
                       "schemaVersion": "1.1",
                       "runtime": {
                           "type": "docker",
                           "settings": {
                               "minDockerVersion": "v1.25",
                               "loggingOptions": "",
                               "registryCredentials": {
                                   "ClassifierRegistry": {
                                       "username": "<Container registry name>",
                                       "password": "<Container registry password>",
                                       "address": "<Container registry name>.azurecr.io"
                                     }
                               }
                           }
                       },
                       "systemModules": {
                           "edgeAgent": {
                               "type": "docker",
                               "settings": {
                                   "image": "mcr.microsoft.com/azureiotedge-agent:1.1",
                                   "createOptions": "{}"
                               }
                           },
                           "edgeHub": {
                               "type": "docker",
                               "status": "running",
                               "restartPolicy": "always",
                               "settings": {
                                   "image": "mcr.microsoft.com/azureiotedge-hub:1.1",
                                   "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"5671/tcp\":[{\"HostPort\":\"5671\"}],\"8883/tcp\":[{\"HostPort\":\"8883\"}],\"443/tcp\":[{\"HostPort\":\"443\"}]}}}"
                               }
                           }
                       },
                       "modules": {
                           "ImageClassifier": {
                               "version": "1.0",
                               "type": "docker",
                               "status": "running",
                               "restartPolicy": "always",
                               "settings": {
                                   "image": "<Container registry name>.azurecr.io/classifier:v1",
                                   "createOptions": "{\"ExposedPorts\": {\"80/tcp\": {}},\"HostConfig\": {\"PortBindings\": {\"80/tcp\": [{\"HostPort\": \"80\"}]}}}"
                               }
                           }
                       }
                   }
               },
               "$edgeHub": {
                   "properties.desired": {
                       "schemaVersion": "1.1",
                       "routes": {
                           "upstream": "FROM /messages/* INTO $upstream"
                       },
                       "storeAndForwardConfiguration": {
                           "timeToLiveSecs": 7200
                       }
                   }
               }
           }
       }
   }
   ```

   > üíÅ You can find this file in the [code-deployment/deployment](code-deployment/deployment) folder.

   Replace the three instances of`<Container registry name>` with the name you used for your container registry. One is in the `ImageClassifier` module section, the other two are in the `registryCredentials` section.

   Replace `<Container registry password>` in the `registryCredentials` section with your container registry password.

1. From the folder containing your deployment manifest, run the following command:

   ```sh
   az iot edge set-modules --device-id fruit-quality-detector-edge  --content deployment.json --hub-name <hub_name>
   ```

   Replace `<hub_name>` with the name of your IoT Hub.

   The image classifier module will be deployed to your edge device.

### Task - verify the classifier is running

1. Connect to the IoT edge device:

   * If you are using a Raspberry Pi to run IoT Edge, connect using ssh either from your terminal, or via a remote SSH session in VS Code

   * If you are running IoT Edge in a Linux container on Windows, follow the steps in the [verify successful configuration guide](https://docs.microsoft.com/azure/iot-edge/how-to-install-iot-edge-on-windows?WT.mc_id=academic-17441-jabenn&view=iotedge-2018-06&tabs=powershell#verify-successful-configuration) to connect to the IoT Edge device.

   * If you are running IoT Edge on a virtual machine, you can SSH into the machine using the `adminUsername` and `password` you set when creating the VM, and using either the IP address or DNS name:

     ```sh
     ssh <adminUsername>@<IP address>
     ```

     Or:

     ```sh
     ssh <adminUsername>@<DNS Name>
     ```

     Enter your password when prompted

1. Once you are connected, run the following command to get the list of IoT Edge modules:

   ```sh
   iotedge list
   ```

   > üíÅ You may need to run this command with `sudo`.

   You will see the running modules:

   ```output
   jim@fruit-quality-detector-jimb:~$ iotedge list
   NAME             STATUS           DESCRIPTION      CONFIG
   ImageClassifier  running          Up 42 minutes    fruitqualitydetectorjimb.azurecr.io/classifier:v1
   edgeAgent        running          Up 42 minutes    mcr.microsoft.com/azureiotedge-agent:1.1
   edgeHub          running          Up 42 minutes    mcr.microsoft.com/azureiotedge-hub:1.1
   ```

1. Check the logs for the Image classifier module with the following command:

   ```sh
   iotedge logs ImageClassifier
   ```

   > üíÅ You may need to run this command with `sudo`.

   ```output
   jim@fruit-quality-detector-jimb:~$ iotedge logs ImageClassifier
   2021-07-05 20:30:15.387144: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
   2021-07-05 20:30:15.392185: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2394450000 Hz
   2021-07-05 20:30:15.392712: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x55ed9ac83470 executing computations on platform Host. Devices:
   2021-07-05 20:30:15.392806: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
   Loading model...Success!
   Loading labels...2 found. Success!
    * Serving Flask app "app" (lazy loading)
    * Environment: production
      WARNING: This is a development server. Do not use it in a production deployment.
      Use a production WSGI server instead.
    * Debug mode: off
    * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
   ```

### Task - test the image classifier

1. You can use CURL to test the image classifier using the IP address or host name of the computer that is running the IoT Edge agent. Find the IP address:

   * If you are on the same machine that IoT Edge is running, you can use `localhost` as the host name.
   * If you are using a VM, you can use either the IP address or the DNS name of the VM
   * Otherwise you can obtain the IP address of the machine running IoT Edge:
     * On Windows 10, follow the [find your IP address guide](https://support.microsoft.com/windows/find-your-ip-address-f21a9bbc-c582-55cd-35e0-73431160a1b9?WT.mc_id=academic-17441-jabenn)
     * On macOS, follow the [how to find you IP address on a Mac guide](https://www.hellotech.com/guide/for/how-to-find-ip-address-on-mac)
     * On linux, follow the section on finding your private IP address in the [how to find your IP address in Linux guide](https://opensource.com/article/18/5/how-find-ip-address-linux)

1. You can test the container with a local file by running the following curl command:

   ```sh
   curl --location --request POST 'http://<IP address or name>/image' --header 'Content-Type: image/png' --data-binary '@<file_Name>' 
   ```

1. Using Power Shell on a windows machine, you can use the following:
   ```powershell
   Invoke-WebRequest -Uri "http://<IP Address or name>/image" -Method Post -ContentType "image/png" -InFile "<file_name>"
   ```

   

   Replace `<IP address or name>` with the IP address or host name of your RPi running IoT Edge. Replace `<file_Name>` with the name of the file to test.

   You will see the prediction results in the output:

   ```output
   {
       "created": "2021-07-05T21:44:39.573181",
       "id": "",
       "iteration": "",
       "predictions": [
           {
               "boundingBox": null,
               "probability": 0.9995615482330322,
               "tagId": "",
               "tagName": "ripe"
           },
           {
               "boundingBox": null,
               "probability": 0.0004384400090202689,
               "tagId": "",
               "tagName": "unripe"
           }
       ],
       "project": ""
   }
   ```

   > üíÅ There is no need to provide a prediction key here, as this is not using an Azure resource. Instead security would be configured on the internal network based on internal security needs, rather than relying on a public endpoint and an API key.

## Use your IoT Edge device

In this step, you will use the Image Classifier running on the IoT Edge device.

## Use the IoT Edge classifier

The IoT device can be re-directed to use the IoT Edge image classifier. The URL for the Image Classifier is `http://<IP address or name>/image`, replacing `<IP address or name>` with the IP address or host name of the computer running IoT Edge.

The Python library for Custom Vision only works with cloud-hosted models, not models hosted on IoT Edge. This means you will need to use the REST API to call the classifier.

### Task - use the IoT Edge classifier

1. Open the `fruit-quality-detector` project in VS Code if it is not already open. If you are using a virtual IoT device, then make sure the virtual environment is activated.

1. Open the `app.py` file, and remove the import statements from `azure.cognitiveservices.vision.customvision.prediction` and `msrest.authentication`.

1. Add the following import at the top of the file:

   ```python
   import requests
   ```

1. Delete all the code after the image is saved to a file, from `image_file.write(image.read())` to the end of the file.

1. Add the following code to the end of the file:

   ```python
   prediction_url = '<URL>'
   headers = {
       'Content-Type' : 'application/octet-stream'
   }
   image.seek(0)
   response = requests.post(prediction_url, headers=headers, data=image)
   results = response.json()
   
   for prediction in results['predictions']:
       print(f'{prediction["tagName"]}:\t{prediction["probability"] * 100:.2f}%')
   ```

   Replace `<URL>` with the URL for your classifier.

   This code makes a REST POST request to the classifier, sending the image as the body of the request. The results come back as JSON, and this is decoded to print out the probabilities.

1. Run your code, with your camera pointing at some fruit, or an appropriate image set, or fruit visible on your webcam if using virtual IoT hardware. You will see the output in the console:

   ```output
   (.venv) ‚ûú  fruit-quality-detector python app.py
   ripe:   56.84%
   unripe: 43.16%
   ```

> üíÅ You can find this code in the [code-classify/pi](code-classify/pi) or [code-classify/virtual-iot-device](code-classify/virtual-iot-device) folder.

üòÄ Your fruit quality classifier program was a success!

### Model retraining

One of the downsides to running image classifiers on IoT Edge is that they are not connected to your Custom Vision project. If you look at the **Predictions** tab in Custom Vision you won't see the images that were classified using the Edge-based classifier.

This is the expected behavior - images are not sent to the cloud for classification, so they won't be available in the cloud. One of the upsides of using IoT Edge is privacy, ensuring that images don't leave your network, another is being able to work offline, so no relying on uploading images when the device has no internet connection. The downside is improving your model - you would need to implement another way of storing images that can be manually re-classified to improve and re-train the image classifier.

‚úÖ Think about ways to upload images to retrain the classifier.