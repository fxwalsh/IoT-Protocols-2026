# MQTT


### Eclipse Paho
You will use the [Eclipse Paho Python client library](https://pypi.org/project/paho-mqtt/) to create a publish and subscribe program as shown in the above diagram. Run the following command in the RPi To install the relevant libraries on the RPi:

```bash
sudo apt-get install mosquitto
```

```bash
sudo pip install paho-mqtt
```

### SenseHat 
You will need to install the relevant SenseHAT Python libraries. Run the following command in the RPi To install the relevant libraries on the RPi:

```bash
sudo apt-get install sense-hat
```


##Publish Temperature

+ On the Raspberry Pi, create a directory called ``mqtt`` in your home directory and ``cd`` into it:

~~~bash
mkdir ~/mqtt
cd mqtt
~~~

+ Create a new script called ``client_pub.py`` and enter the following code:

~~~python
import paho.mqtt.client as mqtt
import urlparse
import sys
import time
import json
from sense_hat import SenseHat

sense = SenseHat()
sense.clear()
# Define event callbacks
def on_connect(client, userdata, flags, rc):
    print("Connection Result: " + str(rc))

def on_publish(client, obj, mid):
    print("Message ID: " + str(mid))

mqttc = mqtt.Client()

# Assign event callbacks
mqttc.on_connect = on_connect
mqttc.on_publish = on_publish

# parse mqtt url for connection details
url_str = sys.argv[1]
print(url_str)
url = urlparse.urlparse(url_str)
base_topic = url.path[1:]

# Connect
if (url.username):
    mqttc.username_pw_set(url.username, url.password)
mqttc.connect(url.hostname, url.port)
mqttc.loop_start()

# Publish a message to temp every 15 seconds
while True:
    temp=round(sense.get_temperature(),2)
    temp_json=json.dumps({"temperature":temp, "timestamp":time.time()})
    mqttc.publish(base_topic+"/temperature", temp_json)
    time.sleep(15)
~~~

+ Examine the above code. The program expects a **MQTT URL** as the first command line argument. The connection details for MQTT broker as then parsed from the URL. 
+ You will publish the temperature reading to the following URL: ``mqtt://test.mosquitto.org:1883/YOUR_ID/home`` where you replace ``YOUR_ID`` in the URL with a memorable id of your choice (For example, I use my Github username, ``fxwalsh``, so my URL is : ``mqtt://test.mosquitto.org:1883/fxwalsh/home``).
+ The program publishes the temperature and a timestamp from the device in question, which in this case is the time in seconds since the 1/1/1970 as a floating point number(the [Linux epoch](https://en.wikipedia.org/wiki/Unix_time)).
+ Run the program, ``python client_pub.py mqtt://test.mosquitto.org:1883/YOUR_ID/home`` and you should see an output to the console similar to the following:

~~~bash
mqtt://test.mosquitto.org:1883/fxwalsh/home
Message ID: 1
Connection Result: 0
Message ID: 2
Message ID: 3
Message ID: 4
~~~

The ``Message ID: ...`` indicates on_publish callback and is called every time a value is publuished to the broker.  ``Connection Result: 0`` is output from the on_connect callback and ``0`` is success but any other number indicates a refused connection. For a more detailed explanation see: [Paho Callbacks](https://pypi.org/project/paho-mqtt/#callbacks).

Your RPi is now hopefully publishing temperature messages to the cloud MQTT broker. Any device anywhere on the internet can now subscribe and use this data.  
**NOTE: Leave this program running for the next section**

### Subscribe

Ideally you can create the following program on another machine, perhaps one of the VMs you have (not dbserver), that can run Python. If you want to use the RPi just for convenience, it's OK to run the following subscribe program on the RPi also by opening a second SSH session (lets just pretend it's on another device somewhere else in the world!).

+ If you are using another device/laptop to subscribe, create a new directory called ``mqtt``. 
+ in the ``mqtt`` directory, create a new Python program file called ``client_sub.py`` with the following content:

~~~python
import paho.mqtt.client as mqtt
import urlparse
import sys

# Define event callbacks
def on_connect(client, userdata, flags, rc):
    print("Connection Result: " + str(rc))

def on_message(client, obj, msg):
    print("Topic:"+msg.topic + ",Payload:" + str(msg.payload))

def on_subscribe(client, obj, mid, granted_qos):
    print("Subscribed,  QOS granted: "+ str(granted_qos))

mqttc = mqtt.Client()

# Assign event callbacks
mqttc.on_message = on_message
mqttc.on_connect = on_connect
mqttc.on_subscribe = on_subscribe

# parse mqtt url for connection details
url_str = sys.argv[1]
url = urlparse.urlparse(url_str)
base_topic = url.path[1:]

# Connect
if (url.username):
    mqttc.username_pw_set(url.username, url.password)
mqttc.connect(url.hostname, url.port)

# Start subscribe, with QoS level 0
mqttc.subscribe(base_topic+"/#", 0)
mqttc.loop_forever()

# Continue the network loop, exit when an error occurs
rc = 0
while rc == 0:
    rc = mqttc.loop()
print("rc: " + str(rc))
~~~

+ Now run it as before, **using the same URL used in for the publishing program** as a command line argument. You should see data output to the console similar to the following:

~~~bash
Connection Result: 0
Subscribed,  QOS granted: (0,)
Topic:fxwalsh/home/temperature,Payload:{"timestamp": 1541453620.862879, "temperature": 34.48}
Topic:fxwalsh/home/temperature,Payload:{"timestamp": 1541453680.936523, "temperature": 34.41}
~~~

You now have a working MQTT publisher/subscriber!

## Optional - use your phone
There are several MQTT client apps available for Android and Mac. 

## Multiple Topics

The SenseHAT on the RPi has a few other environment sensors, for example pressure and humidity. If you presume to operate the RPi as a weather station, you need to publish this data also and create a suiable channel structure for MQTT.
+ On the RPi, stop ``client_pub.py`` by entering ``ctrl + c`` in the terminal window.
+ On the RPi, create a new script in ``~/mqtt`` called  ``client_pub_mult.py`` with the following content:

~~~python
import paho.mqtt.client as mqtt
import paho.mqtt.publish as publish
import urlparse
import sys
import time
import json

from sense_hat import SenseHat

sense = SenseHat()
sense.clear()

# parse mqtt url for connection details
url_str = sys.argv[1]
print(url_str)
url = urlparse.urlparse(url_str)
base_topic = url.path[1:]
auth=None
# Connect
if (url.username):
    auth = {'username':url.username, 'password':url.password}



# Publish a message
while True:
    temp=round(sense.get_temperature(),2)
    humidity=sense.get_humidity()

    #Create JSON strings
    temp_sensor=json.dumps({"temperature":temp, "timestamp":time.time()}) 
    humidity_sensor=json.dumps({"humidity":humidity, "timestamp":time.time()}) 

    #Create array of MQTT messages
    temp_msg={'topic': base_topic +"/temperature", 'payload':temp_sensor}
    hum_msg={'topic':base_topic +"/humidity", 'payload':humidity_sensor}
    msgs=[temp_msg,hum_msg]

    #Publish array of messages
    publish.multiple(msgs, hostname=url.hostname, port=url.port, auth=auth)
    print("published")
    time.sleep(15)
~~~

This time the program uses the publish.mutiple() function to send a list topics and payloads. 

+ The script is missing the pressure value. Inspect the script and update it to publish the pressure sensor reading to ``/pressure``.(hint: use ``sensor.get_pressure()`` to get the pressure value). All going well, you should observe output from the program similar to the following:

~~~bash
Topic:fxwalsh/home/temp,Payload:{'temperature': 34.7}
Topic:fxwalsh/home/humidity,Payload:{'humidity': 48.56332015991211}
Topic:fxwalsh/home/pressure,Payload:{'pressure': 1022.30786133}
Topic:fxwalsh/home/temp,Payload:{'temperature': 34.74}
Topic:fxwalsh/home/humidity,Payload:{'humidity': 48.578670501708984}
Topic:fxwalsh/home/pressure,Payload:{'pressure': 1022.31079102}
~~~

## Optional - use your phone

There are several MQTT client apps available for Android and Mac. 

### Report Requirements - MQTT

+ Include your code for the last step (including pressure data). 


+ How many bytes are you using for the payload in the message for the temperature topic at the moment? Suggest ways to reduce the size of the payload.

~~~json
{"Temperature": 20.635 }
24 bytes 
~~~

+ How small could you make the temperature message? (hint: MQTT does not mandate the use of JSON)

+ At the moment you are publishing to 3 topics. Suggest a justification, if any, to do this. Furthermore, propose how you could combine temperature, pressure and humidity in one JSON message.