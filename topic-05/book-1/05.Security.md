# MQTT Security Hardening 

You are currently using a public Broker where anybody can see and subscribe to your data.
If you want you can set up a broker on a cloud instance such as Amazon Web Services or even a local broker to handle messaging in your home network. 

The public instance we're using supports TLS and supplies a certificate you can use to create a secure connection.

+ Go to https://www.emqx.io/mqtt/public-mqtt5-broker and download the certificate file for TLS:



![TLS Cert](./img/tls.png)

+ Open *client_pub.py* and add the following statement to load the certificate just after ``mqttc.createClient(..)``:

~~~python
mqttc.tls_set("./broker.emqx.io-ca.crt")
~~~

+ We want to be sure that the presence data is published so set the QoS to 1. Update the line of code that publishes the devices to the following:

~~~python
mqttc.publish(base_topic+"/devices", devices_found_json,1)
~~~

+ Now run the publisher client as before, but this time use the TLS port 8883:

~~~python
python3 client_sub.py mqtt://broker.emqx.io:8883/fxwalsh/home
~~~

+ Open *client_sub.py* and add in the certificate in the same way you did for the publishing script and change the port to 8883.

+ Update the line of code that subscribes to the following:

~~~python
    # Start subscribe, with QoS 1
    mqttc.subscribe(base_topic+"/#", 1)
~~~

+ Run the subscription service, you should see it working as before, this time with QoS = 1 and using TLS

## Message Encryption

It's still possible for other people to see your data on this server, even though you're using TLS. Now we'll update the publisher and subscriber to use Payload Encryption. In this case, we will use a cryptography package called **Fernet** that uses symmetric encryption.

+ In **client_pub.py**, add the following code just under the last import statement at the top of the script:

~~~python
from cryptography.fernet import Fernet

def encrypt_payload(payload):
    #HAVING A HARD CODED KEY IS INSECURE  - SHOULD BE ENV/EXTERNAL VARIABLE
    cypher_key=b'xqi9zRusHkcv3Om050HwX82eMTO-LbeW4YlqVVEzpw8=' 
    cypher=Fernet(cypher_key)
    encrypted_payload=cypher.encrypt(payload.encode('utf-8'))
    return(encrypted_payload.decode())
~~~
This creates a function we can use to encrypt the payloads before publishing
+ Find the two statements that publish to the MQTT broker. Replace them with the following:

~~~python
mqttc.publish(base_topic+"/temperature", encrypt_payload(temp_json))
        mqttc.publish(base_topic+"/devices", encrypt_payload(devices_found_json),1)
~~~

Run *client_pub.py* as before. Also, run the MQTT subscription client, *client_sub.py* on your VM. You should now see the encrypted payloads:

~~~bash
broker.emqx.io
8883
Connection Result: 0
Subscribed,  QOS granted: (1,)
Topic:fxwalsh/home/devices,Payload:b'gAAAAABgPCWBMToBUZNLjJavMLLyTj8iFbi9KBXgalXsrorFiX2nVlczO5jApmZ2osTfmsiU3y5ErmXoOFOCI4MRTCXwANcG2cd32ONl1kmLgejEKjLRvxIrBZAOmOi9eDgxXwLsWZtsBWdBHnUMHyYMTkTZ3_NHKA=='
~~~
You now need to add a decryption function to your subscriber
+ Open **client_sub.py** and add the following code just under the last import statement:

~~~python
from cryptography.fernet import Fernet

def decrypt_payload(payload):
    cypher_key=b'xqi9zRusHkcv3Om050HwX82eMTO-LbeW4YlqVVEzpw8=' #THIS IS VERY INSECURE - SHOULD BE ENV/EXTERNAL VARIABLE
    cypher=Fernet(cypher_key)
    decrypted_payload=cypher.decrypt(payload)
    return(decrypted_payload.decode())
~~~
This function uses the same key as the encrypt function used by the publisher and returns the decrypted message.

+ Now replace the ``on_message(..)`` handler to use the decrypt_payload(  ) function when a message is received:

~~~python
def on_message(client, obj, msg):
    print("Topic:"+msg.topic + ",Payload:" + decrypt_payload(msg.payload))
~~~

Run both programs again, you should now see the decrypted message in the ``client_sub.py`` console window as before:

```bash
Topic:fxwalsh/home/temperature,Payload:{"temperature": 33.02, "timestamp": 1614555518.139419}
Topic:fxwalsh/home/devices,Payload:[{"name": "Franks Phone", "mac": "88:29:9C:00:61:A9"}]
```