# Connect Raspberry Pi to Thingspeak MQTT

ThingSpeak enables clients to update and receive updates from channel feeds via the **ThingSpeak MQTT broker**. As in the last lab, you can connect your Raspberry Pi to the MQTT broker and can publish to a ThingSpeak channel or subscribe to updates from that channel.



### Create a ThingSpeak MQTT Device

MQTT access to your channel, including credentials, is handled by a ThingSpeak MQTT device. Your device is configured with the credentials necessary for your MQTT client, in this case your Raspberry Pi,  to communicate with ThingSpeak, and for authorizing specific channels. Create an MQTT device for your Raspberry Pi as follows.

+ In the ThingSpeak menu click **Devices** > **MQTT**.  

<img src="./img/mqtt-device-start1.png" alt="Device menu" style="zoom:80%;" />

+ On the MQTT Devices page, click **Add Device** > **Add a new device**.  

<img src="./img/mqtt-device-start2.png" alt="Add device option" style="zoom:80%;" />

+ Fill in the *Add a new device* dialog as follows:

+ Enter Name and Description as shown below. In Authorize Channels to access, select **"SensePi**" and click **"Add Channel"**   followed by **"Add Device**":

<img src="./img/dialog.png" alt="Dialog" style="zoom:80%;" />]

+ ThingSpeak will now generates a list of credentials for your device that includes client ID, username, and password. 

+ Click **Download Credentials**, select the **Plain Text** option,  and save the credentials in a local file. **Important: Record or save your credentials now, as you will not get another opportunity to view or save the password.**

<img src="./img/cred.png" alt="creds" style="zoom:80%;" />

+ Click **Done** to complete the device creation.

## Write Temperature Data From Raspberry Pi

### Create .env file with configuration data

In last weeks lab, we used the dot_env to separate configuration data from the code. This is a good idea, particularly if your code needs to use API keys and passwords.

+ **On the Raspberry Pi,** in your home directory, create a new folder called *week8-lab2*. 

+ Create a new file called *.env* and enter the following data:

+ Copy the contents of the Plain Text credentials file into .env. 
  It should look like the following (your values will be different).

~~~Text
username = LwogBrFyDd4lKhEkORo8AAA
clientId = LwogBrFyDd4lKhEkORo8AAA
password = 7c+vxaw3CVLredzEsheaHy7B
~~~

+ Finally, add the ***SensePi channel ID*** and ***transmissionInterval*** to the .*env* file. You can get the SensePi channel ID from the **Channels tab in Thingspeak**.

~~~text
username = LwogBrFyDd4lKhEkORo8AAA
clientId = LwogBrFyDd4lKhEkORo8AAA
password = 7c+vxaw3CVLredzEsheaHy7B
channelId=1319831
transmissionInterval=15
~~~

![Channel ID)](./img/channelid.png)

### Python Script

+ In the same folder as the file .env ( *week9-lab2*), create a new file called *thingspeak-pub.py* and insert the following code: 

~~~python
#!/usr/bin/python3

import paho.mqtt.client as mqtt
from urllib.parse import urlparse
import sys
import time
from sense_hat import SenseHat
import logging
from dotenv import dotenv_values

#Initialise SenseHAT
sense = SenseHat()
sense.clear()

#load MQTT configuration values from .env file
config = dotenv_values(".env")

#configure Logging
logging.basicConfig(level=logging.INFO)

# Define event callbacks for MQTT
def on_connect(client, userdata, flags, rc):
    logging.info("Connection Result: " + str(rc))

def on_publish(client, obj, mid):
    logging.info("Message Sent ID: " + str(mid))

mqttc = mqtt.Client(client_id=config["clientId"])

# Assign event callbacks
mqttc.on_connect = on_connect
mqttc.on_publish = on_publish

# parse mqtt url for connection details
url_str = sys.argv[1]
print(url_str)
url = urlparse(url_str)
base_topic = url.path[1:]

# Configure MQTT client with user name and password
mqttc.username_pw_set(config["username"], config["password"])

#Connect to MQTT Broker
mqttc.connect(url.hostname, url.port)
mqttc.loop_start()

#Set Thingspeak Channel to publish to
topic = "channels/"+config["channelId"]+"/publish"

# Publish a message to temp every 15 seconds
while True:
    try:
        temp=round(sense.get_temperature(),2)
        payload="field1="+str(temp)
        mqttc.publish(topic, payload)
        time.sleep(int(config["transmissionInterval"]))
    except:
        logging.info('Interrupted')
~~~

- Run the script by typing ``python thingspeak-pub.py mqtt://mqtt3.thingspeak.com:1883``. You should see data appear in the channel as before. 

## Testing

This time, it's real sensor data. You can perform a rudimentary test by altering the threshold value in the *React* app to be approximately about 0.5C the current temp returned by the sensor. Then, lightly blow on the SenseHAT to reduce the Temperature temporarily. When it rises again it should trigger the React!

Alternatively, you can still use Postman or your Browser to write data to the channel. 

+ Write a value that exceeds the Threshold and check for a Tweet!

